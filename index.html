<!DOCTYPE HTML>
<html>
    <head>
        <title>DrumPads</title>
        <meta charset="utf-8">
        
        <script src="js/Tone.js" type="text/javascript">
        </script>
        
        <script src="js/nexusUI.js" type="text/javascript">
        </script>
          
        <link rel="stylesheet" type="text/css" href="style.css">
        
        </head>
    
    <body id="mainBody">
    
        
        <div id ="padArea">
            
            
           <canvas nx="button"></canvas>
           <canvas nx="button"></canvas>
           <canvas nx="button"></canvas>
           <br>
           <canvas nx="button"></canvas>
           <canvas nx="button"></canvas>
           <canvas nx="button"></canvas>
           <br>
           <canvas nx="button"></canvas>
           <canvas nx="button"></canvas>
           <canvas nx="button"></canvas>
           
        </div>
    
        <div id="controlBar">
           

           <canvas nx="tabs"></canvas>
           <img id="logo" src="Logo.png" alt="logo" height="100%" width="30%">
           <canvas nx="toggle" label="Help" labelAlign = "right">
               
           </canvas>
           
       </div>
        
      
    </body>
    
    <script>
        
        //set up players
        var kitplayer = [];
        
        //Global Counter
        var count;
        
        
    //load Kit to Buffers
    var loadKit = function (kitNumber)
    {
       for(var i=1; i<=9; i++)
       {
          
           console.log ("samples/Kit" + kitNumber + "/" + i + ".wav");
            kitplayer[i] = new Tone.Player ("samples/Kit" + kitNumber + "/" + i + ".wav").toMaster();
            kitplayer[i].retrigger = true;
       }
    }
    
    //Call Load Kit 1 as start up Default Kit
    loadKit(1);
    
        //Reverb Setup
        var reverbFX = new Tone.Freeverb();
        reverbFX.dampening.value = 1000;
        reverbFX.receive("reverbBus");
        reverbFX.connect(Tone.Master);
        
        //Microphone Setup
        navigator.getUserMedia = navigator.getUserMedia ||
        navigator.webkitGetUserMedia ||
        navigator.mozGetUserMedia;
        
        //microphone Functions
        var config = {
            audio: true,
            video: false,
        };
    
    
        //sucessful stream action
        function streamActions(stream){
        console.log("Streaming");
        window.audioContext = new AudioContext();
        var userMediaStream = stream;
        window.mediaStreamSource = audioContext.createMediaStreamSource(stream);
        window.analyser = audioContext.createAnalyser();
        
        //SetFFTSize
        //This is maximum size of fft analyser window which = 0.74 second clip at 44.1hz
        analyser.fftSize = 32768;
        
        window.mediaStreamSource.connect( analyser );
        
        };
    
        // Stream fail action
        function streamFailActions(error){
        console.log("Unable to Access Microphone" + error);
        }
    
        // start streaming from the microphone
        navigator.getUserMedia(config, streamActions, streamFailActions);
        
       
//////////////////////////////// EVENT LISTENERS ////////////////////////////

        // Nexus UI onload Setup
           nx.onload = function()
           {

            //Buttons
            
            button1.on('*', function(btn){ ButtonActions(btn, 1); });
            button1.mode = "aftertouch";
            
            
            button2.on('*', function(btn){ ButtonActions(btn, 2); });
            button2.mode = "aftertouch";
            
            
            button3.on('*', function(btn){ ButtonActions(btn, 3); });
            button3.mode = "aftertouch";
            
            
            button4.on('*', function(btn){ ButtonActions(btn, 4); });
            button4.mode = "aftertouch";
            
            
            button5.on('*', function(btn){ ButtonActions(btn, 5); });
            button5.mode = "aftertouch";
            
            
            button6.on('*', function(btn){ ButtonActions(btn, 6); });
            button6.mode = "aftertouch";
            
            
            button7.on('*', function(btn){ ButtonActions(btn, 7); });
            button7.mode = "aftertouch";
            
            
            button8.on('*', function(btn){ ButtonActions(btn, 8); });
            button8.mode = "aftertouch";
            
            
            button9.on('*', function(btn){ ButtonActions(btn, 9); });
            button9.mode = "aftertouch";
            
            
            //Help Toggle
            toggle1.on('*', helpFunction);
           
            //Kit Tabs
            tabs1.on('*', kitSelect);
            
           }
    
//////////////////////////////// CALLBACK FUNCTIONS ////////////////////////////

    var playSoundFor = function(btn, playerNumber)
    {
        
            
            
    }


    
    //Help Button Function
    var helpFunction = function(event){
         console.log(event);
         if(event.value ==1)        {
        alert("WELCOME TO THE UNSTABLE DRUM MACHINE \n Press Drum Pads to Trigger Sounds \n Hold Drum Pads until the background colour changes green to record. Keep holding the Pad while recording and press again to trigger sound \n To change Kit press the option tabs, Kit 3 is a blank template for you to record your sounds")
        }
         
    }
    
    //Kit Select Function
    function kitSelect(){
        if (tabs1.val.index == 0)
        {
            console.log("loaded kit 1");
            loadKit(1);
        }
        
        if (tabs1.val.index == 1)
        {
            console.log("loaded kit 2");
            loadKit(2);
        }
    
        if (tabs1.val.index == 2)
        {
            console.log("loaded kit 3");
            //Enpty Kit to fill with recorded sounds
            loadKit(3);
        }
        
    }
    
    
//////////////////////////////// Microphone FUNCTIONS ////////////////////////////
    
    //make PlayerBuffer
    
    // we'll use this timer for recording
    var GLobtimer;
    var GlobplayerIndex;
    
    //TimerFuctions
    function startTimer() {
        count = 1;
        timer = window.setInterval(timerCallback, 1000);
    }
    
    function timerCallback(){
        console.log(count)
        count = count + 1
        
        if(count == 3){
            //The color change feedback has been put on counter = 3 to allow for better user timing
            //when recording
            document.getElementById("padArea").style.background =  "#00ff00"
        }
    

        if(count == 4){
            //Write Audio BUFFFEEERRRR to Tone JS player
            recordAndSetPlayer();
            
        }
    }

    
    var ButtonActions = function(btn, playerNumber)
    {
        //Do some stuff with press on and off
        if (btn.press == 1 ) //(btn. > 0.2)
        {
            console.log("timer started");
            //Assigns GlobPlayerIndex for use in recording to player number.
            GlobplayerIndex = playerNumber
            startTimer();
           
            //Testplayer.start();
            kitplayer[playerNumber].start();
        }
        
        if (btn.press == 0 ) //(btn. > 0.2)
        {
            clearInterval(timer);
            console.log("restarted timer");
            //stopRecording
            //Change Colour back to Default Blue
            document.getElementById("padArea").style.background = "#00ffff"
        }
        
        //Do some stuff with X Y aftertouch
        if (event.y > 0.2 )
        {
            //console.log("over");
            //player[1].send("reverbBus", -40);
        }
        else
        {
            //console.log("under");
        }


    }
    
   
    function recordAndSetPlayer(){
        console.log("recording");
        // we aim to put our audio data into an AudioBuffer
        // but we must first retrieve sampled data from the analyser node
        var audioDataSize = 32768;
        // 4096
        var audioDataFloat = new Float32Array( audioDataSize );
        window.analyser.getFloatTimeDomainData(audioDataFloat);
        
        console.log( audioDataFloat );
        
        //Testplayer.buffer.fromArray(audioDataFloat, 1);
        
        // create an audio buffer to pass to the pitch detection library
        var numChannels = window.mediaStreamSource.channelCount;
        var numSamples  = audioDataSize;
        var sampleRate  = window.audioContext.sampleRate;
        
        //Write Audio Context to the Audio BUFFFEEERRRR
        var tempAudioBuffer = audioContext.createBuffer(numChannels, numSamples, sampleRate);
        
        // now put our data into the first channel of the audio buffer
        // TODO - we might have an if that checks the numChannels
        //        and loops around putting the data in all channels
        //        (for mono source into a stereo buffer)
        tempAudioBuffer.copyToChannel(audioDataFloat, 0);
        
        //tempAudioBuffer.copyToChannel(audioDataFloat, 1);
        
        //write to Player
        //Testplayer.buffer = tempAudioBuffer;
        kitplayer[GlobplayerIndex].buffer = tempAudioBuffer
        
        //for Debugging I wanted to see if any data was inside the Buffer
        console.log(tempAudioBuffer);
    }
    
    
    





</script>
    
    
</html>


