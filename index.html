<!DOCTYPE HTML>
<html>
    <head>
        <title>DrumPads</title>
        <meta charset="utf-8">
        
        <script src="js/Tone.js" type="text/javascript">
        </script>
        
        <script src="js/nexusUI.js" type="text/javascript">
        </script>
          
        <link rel="stylesheet" type="text/css" href="style.css">
        
        </head>
    
    <body id="mainBody">
    
        
        <div id ="padArea">
            
            
           <canvas nx="button"></canvas>
           <canvas nx="button"></canvas>
           <canvas nx="button"></canvas>
           <br>
           <canvas nx="button"></canvas>
           <canvas nx="button"></canvas>
           <canvas nx="button"></canvas>
           <br>
           <canvas nx="button"></canvas>
           <canvas nx="button"></canvas>
           <canvas nx="button"></canvas>
           
        </div>
    
        <div id="controlBar">
           <canvas nx="tabs"></canvas>
           <canvas nx="toggle"></canvas>
           
       </div>
        
      
    </body>
    
    <script>
        
        //set up players
        var kitplayer = [];
        
        //Global Counter for Button Hold Timer 
        var count;
        
        
    //load Kit to Buffers
    var loadKit = function (kitNumber)
    {
       for(var i=1; i<=9; i++)
       {
          
           console.log ("samples/Kit" + kitNumber + "/" + i + ".wav");
            kitplayer[i] = new Tone.Player ("samples/Kit" + kitNumber + "/" + i + ".wav").toMaster();
            kitplayer[i].retrigger = true;
       }
    }
    
    //Call Load Kit 1 as start up Default Kit
    loadKit(1);
    
        //Reverb Setup
        var reverbFX = new Tone.Freeverb();
        reverbFX.dampening.value = 1000;
        reverbFX.receive("reverbBus");
        reverbFX.connect(Tone.Master);
        
        //Microphone Setup
        navigator.getUserMedia = navigator.getUserMedia ||
        navigator.webkitGetUserMedia ||
        navigator.mozGetUserMedia;
        
        //microphone Functions
        var config = {
            audio: true,
            video: false,
        };

        function streamActions(stream){
        console.log("Streaming");
        window.audioContext = new AudioContext();
        window.userMediaStream = stream;
        window.mediaStreamSource = audioContext.createMediaStreamSource(stream);
        window.analyser = audioContext.createAnalyser();
        
        //SetFFTSize
        analyser.fftSize = 32768;
        //2048
        window.mediaStreamSource.connect( analyser );
        
        
        };
    
        function streamFailActions(error){
        console.log("error" + error);
        }
    
        // start streaming from the microphone
        navigator.getUserMedia(config, streamActions, streamFailActions);
        
       
//////////////////////////////// EVENT LISTENERS ////////////////////////////

           nx.onload = function()
           {
  
            //Buttons
            
            button1.on('*', function(btn){ RecordSound(btn, 1); });
            button1.mode = "aftertouch";
            
            
            button2.on('*', function(btn){ RecordSound(btn, 2); });
            button2.mode = "aftertouch";
            
            
            button3.on('*', function(btn){ RecordSound(btn, 3); });
            button3.mode = "aftertouch";
            
            
            button4.on('*', function(btn){ RecordSound(btn, 4); });
            button4.mode = "aftertouch";
            
            
            button5.on('*', function(btn){ RecordSound(btn, 5); });
            button5.mode = "aftertouch";
            
            
            button6.on('*', function(btn){ RecordSound(btn, 6); });
            button6.mode = "aftertouch";
            
            
            button7.on('*', function(btn){ RecordSound(btn, 7); });
            button7.mode = "aftertouch";
            
            
            button8.on('*', function(btn){ RecordSound(btn, 8); });
            button8.mode = "aftertouch";
            
            
            button9.on('*', function(btn){ RecordSound(btn, 9); });
            button9.mode = "aftertouch";
            
            
            //Help Toggle
            toggle1.on('*', helpFunction);
            
            //Kit Tabs
            tabs1.on('*', kitSelect);
            
           }
    
//////////////////////////////// CALLBACK FUNCTIONS ////////////////////////////

//     var playSoundFor = function(btn, playerNumber)
//     {
//          if (btn.press == 1)
//          {
//             var InitialyPos = btn.y;
//             //console.log(playerNumber);
//             kitplayer[playerNumber].start();
            
//             if (event.y > 0.2 )
//             {
//                 console.log("over");
//                 //player[1].send("reverbBus", -40);
//             }
//             else
//             {
//                 console.log("under");
//             }
//          }
//     }


    
    //Help Button Function
    var helpFunction = function(event){
         console.log(event);
         if(event.value ==1)        {
        alert("WELCOME TO THE UNSTABLE DRUM MACHINE \n How")
        }
        else
        {
            console.log("L4u")
        }
    
    }
    
    //Kit Select Function
    function kitSelect(){
        if (tabs1.val.index == 0)
        {
            console.log("loaded kit 1");
            loadKit(1);
        }
        
        if (tabs1.val.index == 1)
        {
            console.log("loaded kit 2");
            loadKit(2);
        }
    
        if (tabs1.val.index == 2)
        {
            console.log("loaded kit 3");
            loadKit(3);
        }
        
    }
    
    
//////////////////////////////// Microphone FUNCTIONS ////////////////////////////
    
    //make PlayerBuffer
    
    // we'll use this timer for recording
    var GLobtimer;
    var GlobplayerIndex;
    
    //TimerFuctions
    function startTimer() {
        count = 1;
        timer = window.setInterval(timerCallback, 1000);
    }
    
    function timerCallback(){
        console.log(count)
        count = count + 1
        if(count == 4){
            recordAndSetTestPlayer();
            //Write Audio BUFFFEEERRRR to Tone JS player
            
        }
    }

    
    var RecordSound = function(btn, playerNumber)
    {
        
        if (btn.press == 1 ) //(btn. > 0.2)
        {
            
            console.log("timer started");
            //Assigns GlobPlayerIndex for use in recording to player number.
            GlobplayerIndex = playerNumber
            startTimer();
           
            //Testplayer.start();
            kitplayer[playerNumber].start();
            
           
        }
        
        if (btn.press == 0 ) //(btn. > 0.2)
        {
            clearInterval(timer);
            console.log("restarted interval");
            //stopRecording();
        }

    }
    
   
    function recordAndSetTestPlayer(){
        console.log("recording");
        // we aim to put our audio data into an AudioBuffer
        // but we must first retrieve sampled data from the analyser node
        var audioDataSize = 32768;
        // 4096
        var audioDataFloat = new Float32Array( audioDataSize );
        window.analyser.getFloatTimeDomainData(audioDataFloat);
        
        console.log( audioDataFloat );
        
        //Testplayer.buffer.fromArray(audioDataFloat, 1);
        
        // create an audio buffer to pass to the pitch detection library
        var numChannels = window.mediaStreamSource.channelCount;
        var numSamples  = audioDataSize;
        var sampleRate  = window.audioContext.sampleRate;
        
        //Write Audio Context to the Audio BUFFFEEERRRR
        var tempAudioBuffer = audioContext.createBuffer(numChannels, numSamples, sampleRate);
        
        // now put our data into the first channel of the audio buffer
        // TODO - we might have an if that checks the numChannels
        //        and loops around putting the data in all channels
        //        (for mono source into a stereo buffer)
        tempAudioBuffer.copyToChannel(audioDataFloat, 0);
        
        //write to Player
        //Testplayer.buffer = tempAudioBuffer;
        kitplayer[GlobplayerIndex].buffer = tempAudioBuffer
        console.log(tempAudioBuffer);
    }
    
</script>
    
    
</html>
